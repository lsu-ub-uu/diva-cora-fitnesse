---
Test
---
!2 !-Indexering av personposter ifrån Classic-!

!***> Konfigurationen för testet 
!| Import |
| fitnesse.fixtures | 

!| JmsMessageRoutingInfoFixture |
| hostname | port | routingKey | username | password | createInHolder? |
| diva-docker-fedora | 61616 | fedora.apim.update | fedoraAdmin | fedora | |

!define currentAuthToken {$adminAuthToken}
!define recordType {person}
!define sleepTime {2000}
*!

När det skapas nya personposter eller görs ändringar på befintliga personposter i Classic så vill vi att dessa poster ska indexeras (om) i Cora Solr. När det sker händelser i Classics fedora, läggs det meddelanden i ett kösystem som diva-indexmessenger prenumererar på. Vissa av dessa meddelanden kan knytas till för oss relevanta händelser, som skapning, uppdatering eller radering av en personpost. I alla dessa fall är det önskade resultatet att posten indexeras (om) i Cora-solr.

 * '''Fall 1:''' När en ny personpost skapas, ska den indexeras i Cora. 
 * '''Fall 2:''' När en personpost uppdateras, ska den indexeras i Cora. 
 * '''Fall 3:''' När en personpost raderas, ska indexeringen tas bort i Cora.
 * '''Fall 4:''' När en personpost purge:as, ska indexeringen tas bort i Cora.
 * '''Fall 5:''' Andra händelser än skapelse, uppdatering och radering ska inte indexera någon personpost i Cora.
 
 !style_blue[Det ska komplementeras med andra fall när meddelandet innehåller felaktig data.]

!***> Fall 1

!***> Vi förbereder testet. 
!include -seamless .TheDiVATests.DivaTests.Authority.Person.data.dataPerson106
Vi ta bort index för ${recordId} i solr

!include -seamless .HelperPages.removeIndex
*!

!***> Vi kollar att vi får '''noll''' träff för en sökning efter ${recordId} (i.e. att den '''inte är''' indexerat i solr)
!| RecordEndpointFixture |
| authToken | searchId | json | testSearchRecord? | getStatusType? |
| ${currentAuthToken} | ${searchId} | ${searchQueryData} | =~/"data":\[\],"totalNo":"0"/ | OK |
*!

!***> Vi simulerar att det skapas en personpost (${recordId}) i DiVA Classic 

!| MessageSenderFixture |
| headers | message | sendMessage? |
| {methodName:ingest, pid:"${recordId}"} | <?xml version="1.0" encoding="UTF-8"?><entry xmlns="http://www.w3.org/2005/Atom" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:fedora-types="http://www.fedora.info/definitions/1/0/types/"><id>urn:uuid:20f99ff9-9a32-4df0-a937-e62ed562ca28</id><updated>2021-04-19T09:00:05.238Z</updated><author><name>fedoraAdmin</name><uri>http://localhost:8088/fedora</uri></author><title type="text">ingest</title><category term="Created object for Mars, Odin" scheme="fedora-types:logMessage" label="xsd:string"></category><category term="info:fedora/fedora-system:FOXML-1.1" scheme="fedora-types:format" label="xsd:string"></category><summary type="text">${recordId}</summary><content type="text">${recordId}</content><category term="32.1" scheme="info:fedora/fedora-system:def/view#version"></category><category term="info:fedora/fedora-system:ATOM-APIM-1.0" scheme="http://www.fedora.info/definitions/1/0/types/formatURI"></category></entry> | OK |
| {methodName:addDatastream, pid:"${recordId}"} | <?xml version="1.0" encoding="UTF-8"?><entry xmlns="http://www.w3.org/2005/Atom" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:fedora-types="http://www.fedora.info/definitions/1/0/types/">  <id>urn:uuid:dcf0f42d-1f02-4d2b-b21b-5656340a4607</id>  <updated>2021-04-19T09:00:05.515Z</updated>  <author>    <name>fedoraAdmin</name>    <uri>http://localhost:8088/fedora</uri>  </author>  <title type="text">addDatastream</title>  <category term="${recordId}" scheme="fedora-types:pid" label="xsd:string"></category>  <category term="METADATA" scheme="fedora-types:dsID" label="xsd:string"></category>  <category term="null" scheme="fedora-types:altIDs" label="fedora-types:ArrayOfString"></category>  <category term="XML metadata" scheme="fedora-types:dsLabel" label="xsd:string"></category>  <category term="true" scheme="fedora-types:versionable" label="xsd:boolean"></category>  <category term="null" scheme="fedora-types:formatURI" label="xsd:string"></category>  <category term="uploaded://214319" scheme="fedora-types:dsLocation" label="xsd:string"></category>  <category term="M" scheme="fedora-types:controlGroup" label="xsd:string"></category>  <category term="A" scheme="fedora-types:dsState" label="xsd:string"></category>  <category term="SHA-512" scheme="fedora-types:checksumType" label="xsd:string"></category>  <category term="null" scheme="fedora-types:checksum" label="xsd:string"></category>  <category term="Added datastream METADATA" scheme="fedora-types:logMessage" label="xsd:string"></category>  <summary type="text">${recordId}</summary>  <content type="text">METADATA</content>  <category term="32.1" scheme="info:fedora/fedora-system:def/view#version"></category>  <category term="info:fedora/fedora-system:ATOM-APIM-1.0" scheme="http://www.fedora.info/definitions/1/0/types/formatURI"></category></entry> | OK |
*!

!***> Vi väntar ${sleepTime} millisekunder så att Cora hinner läsa och indexera posten
!| Sleep | ${sleepTime} |
*!

!***> Vi kollar att vi får '''ett''' träff för en sökning efter ${recordId} (i.e. att den '''är''' indexerat i solr)
!| RecordEndpointFixture |
| authToken | searchId | json | testSearchRecord? | getStatusType? |
| ${currentAuthToken} | ${searchId} | ${searchQueryData} | =~/"totalNo":"1"/ | OK |
*!
*!
!***> Fall 2
!style_blue[OBS: Vi kollar bara att posten har blivit indexerat i solr. Vi har just nu ingen möjlighet att härifrån programmatiskt ändra en post i DiVA-Classic.]

!***> Vi förbereder testet. 
!include -seamless .TheDiVATests.DivaTests.Authority.Person.data.dataPerson106
Vi ta bort index för ${recordId} i solr

!include -seamless .HelperPages.removeIndex
*!

!***> Vi kollar att vi får '''noll''' träff för en sökning efter ${recordId} (i.e. att den '''inte är''' indexerat i solr)
!| RecordEndpointFixture |
| authToken | searchId | json | testSearchRecord? | getStatusType? |
| ${currentAuthToken} | ${searchId} | ${searchQueryData} | =~/"data":\[\],"totalNo":"0"/ | OK |
*!

!***> Vi simulerar att det uppdateras en personpost (${recordId}) i DiVA Classic 


!| MessageSenderFixture |
| headers | message | sendMessage? |
| {methodName:modifyDatastreamByReference, pid:"${recordId}"} | <?xml version="1.0" encoding="UTF-8"?><entry xmlns="http://www.w3.org/2005/Atom" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:fedora-types="http://www.fedora.info/definitions/1/0/types/">  <id>urn:uuid:8c64a8a2-4f0d-4d6a-bc12-4ef2b6006c34</id>  <updated>2021-04-19T13:09:53.716Z</updated>  <author>    <name>fedoraAdmin</name>    <uri>http://localhost:8088/fedora</uri>  </author>  <title type="text">modifyDatastreamByReference</title>  <category term="${recordId}" scheme="fedora-types:pid" label="xsd:string"></category>  <category term="METADATA" scheme="fedora-types:dsID" label="xsd:string"></category>  <category term="" scheme="fedora-types:altIDs" label="fedora-types:ArrayOfString"></category>  <category term="XML metadata" scheme="fedora-types:dsLabel" label="xsd:string"></category>  <category term="" scheme="fedora-types:formatURI" label="xsd:string"></category>  <category term="uploaded://214321" scheme="fedora-types:dsLocation" label="xsd:string"></category>  <category term="null" scheme="fedora-types:checksumType" label="xsd:string"></category>  <category term="null" scheme="fedora-types:checksum" label="xsd:string"></category>  <category term="James Bond saved" scheme="fedora-types:logMessage" label="xsd:string"></category>  <category term="false" scheme="fedora-types:force" label="xsd:boolean"></category>  <summary type="text">${recordId}</summary>  <content type="text">2021-04-19T13:09:53.715Z</content>  <category term="32.1" scheme="info:fedora/fedora-system:def/view#version"></category>  <category term="info:fedora/fedora-system:ATOM-APIM-1.0" scheme="http://www.fedora.info/definitions/1/0/types/formatURI"></category></entry> | OK |
*!

!***> Vi väntar ${sleepTime} millisekunder så att Cora hinner läsa och indexera posten.
!| Sleep | ${sleepTime} |
*!

!***> Vi kollar att vi får '''ett''' träff för en sökning efter ${recordId} (i.e. att den '''är''' indexerat i solr)
!| RecordEndpointFixture |
| authToken | searchId | json | testSearchRecord? | getStatusType? |
| ${currentAuthToken} | ${searchId} | ${searchQueryData} | =~/"totalNo":"1"/ | OK |
*!
*!
!***> Fall 3

!***> Vi kollar att vi får '''ett''' träff för en sökning efter ${recordId} (i.e. att den '''är''' indexerat i solr)
!| RecordEndpointFixture |
| authToken | searchId | json | testSearchRecord? | getStatusType? |
| ${currentAuthToken} | ${searchId} | ${searchQueryData} | =~/"totalNo":"1"/ | OK |
*!

!***> Vi simulerar att det raderas en personpost (${recordId}) i DiVA Classic 

!| MessageSenderFixture |
| headers | message | sendMessage? |
| {methodName:modifyObject, pid:"${recordId}"} | <?xml version="1.0" encoding="UTF-8"?><entry xmlns="http://www.w3.org/2005/Atom" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:fedora-types="http://www.fedora.info/definitions/1/0/types/">  <id>urn:uuid:a3a24e16-2747-4d78-bf7c-023ee669dfb3</id>  <updated>2021-04-19T08:52:21.593Z</updated>  <author>    <name>fedoraAdmin</name>    <uri>http://localhost:8088/fedora</uri>  </author>  <title type="text">modifyObject</title>  <category term="${recordId}" scheme="fedora-types:pid" label="xsd:string"></category>  <category term="D" scheme="fedora-types:state" label="xsd:string"></category>  <category term="null" scheme="fedora-types:label" label="xsd:string"></category>  <category term="Marked as deleted" scheme="fedora-types:logMessage" label="xsd:string"></category>  <summary type="text">${recordId}</summary>  <content type="text">2021-04-19T08:52:21.593Z</content>  <category term="32.1" scheme="info:fedora/fedora-system:def/view#version"></category>  <category term="info:fedora/fedora-system:ATOM-APIM-1.0" scheme="http://www.fedora.info/definitions/1/0/types/formatURI"></category></entry> | OK |
*!

!***> Vi väntar ${sleepTime} millisekunder så att Cora hinner läsa och indexera posten
!| Sleep | ${sleepTime} |
*!

!***> Vi kollar att vi får '''noll''' träff för en sökning efter ${recordId} (i.e. att den '''inte är''' indexerat i solr)
!| RecordEndpointFixture |
| authToken | searchId | json | testSearchRecord? | getStatusType? |
| ${currentAuthToken} | ${searchId} | ${searchQueryData} | =~/"totalNo":"0"/ | OK |
*!
*!
!***> Fall 4

!***> Vi förbereder testet.
!***> Skapa indexer för record ${recordType} med ID ${recordId}
!| RecordEndpointFixture |
| authToken | type | json | testCreateRecord? | getStatusType? | getCreatedId? |
| ${currentAuthToken} | workOrder | {"name":"workOrder","children":[{"name":"recordType","children":[{"name":"linkedRecordType","value":"recordType"},{"name":"linkedRecordId","value":"${recordType}"}]},{"name":"recordId","value":"${recordId}"},{"name":"type","value":"index"}]} | | CREATED | $createdId2= |
*!
*!

!***> Vi kollar att vi får '''ett''' träff för en sökning efter ${recordId} (i.e. att den '''är''' indexerat i solr)

!| RecordEndpointFixture |
| authToken | searchId | json | testSearchRecord? | getStatusType? |
| ${currentAuthToken} | ${searchId} | ${searchQueryData} | =~/"totalNo":"1"/ | OK |
*!

!***> Vi simulerar att det purge:as en personpost (${recordId}) i DiVA Classic 

!| MessageSenderFixture |
| headers | message | sendMessage? |
| {methodName:purgeObject, pid:"${recordId}"} | <?xml version="1.0" encoding="UTF-8"?><entry xmlns="http://www.w3.org/2005/Atom" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:fedora-types="http://www.fedora.info/definitions/1/0/types/">  <id>urn:uuid:3e298b59-c328-47f0-b3e8-b9bb4d2e1c75</id>  <updated>2021-04-19T13:19:05.673Z</updated>  <author>    <name>fedoraAdmin</name>    <uri>http://localhost:8088/fedora</uri>  </author>  <title type="text">purgeObject</title>  <category term="${recordId}" scheme="fedora-types:pid" label="xsd:string"></category>  <category term="because I want" scheme="fedora-types:logMessage" label="xsd:string"></category>  <category term="false" scheme="fedora-types:force" label="xsd:boolean"></category>  <summary type="text">${recordId}</summary>  <content type="text">2021-04-19T13:19:05.673Z</content>  <category term="32.1" scheme="info:fedora/fedora-system:def/view#version"></category>  <category term="info:fedora/fedora-system:ATOM-APIM-1.0" scheme="http://www.fedora.info/definitions/1/0/types/formatURI"></category></entry> | OK |
*!

!***> Vi väntar ${sleepTime} millisekunder så att Cora hinner läsa och indexera posten
!| Sleep | ${sleepTime} |
*!

!***> Vi kollar att vi får '''noll''' träff för en sökning efter ${recordId} (i.e. att den '''inte är''' indexerat i solr)
!| RecordEndpointFixture |
| authToken | searchId | json | testSearchRecord? | getStatusType? |
| ${currentAuthToken} | ${searchId} | ${searchQueryData} | =~/"totalNo":"0"/ | OK |
*!
*!
!***> Fall 5

!***> Vi kollar att vi får '''noll''' träff för en sökning efter ${recordId} (i.e. att den '''inte är''' indexerat i solr)
!| RecordEndpointFixture |
| authToken | searchId | json | testSearchRecord? | getStatusType? |
| ${currentAuthToken} | ${searchId} | ${searchQueryData} | =~/"data":\[\],"totalNo":"0"/ | OK |
*!

!***> Vi simulerar att det skapas en personpost (${recordId}) i DiVA Classic 

!| MessageSenderFixture |
| headers | message | sendMessage? |
| {methodName:anyOtherMethod, pid:"${recordId}"} | Another message | OK |
*!

!***> Vi väntar ${sleepTime} millisekunder så att Cora hinner läsa och indexera posten
!| Sleep | ${sleepTime} |
*!

!***> Vi kollar att vi får '''noll''' träff för en sökning efter ${recordId} (i.e. att den '''inte är''' indexerat i solr)
!| RecordEndpointFixture |
| authToken | searchId | json | testSearchRecord? | getStatusType? |
| ${currentAuthToken} | ${searchId} | ${searchQueryData} | =~/"data":\[\],"totalNo":"0"/ | OK |
*!
*!

